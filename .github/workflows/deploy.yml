name: Deploy
on:
  push:
    branches-ignore:
      - main
permissions:
  id-token: write
  contents: read

jobs:
  set-environment:
    runs-on: ubuntu-latest
    outputs:
      ENV: ${{ steps.set-environment.outputs.ENV }}
      BACK_STAGE: ${{ steps.set-environment.outputs.BACK_STAGE }}
      FRONT_STAGE: ${{ steps.set-environment.outputs.FRONT_STAGE }}
      MOBILE_API_STAGE: ${{ steps.set-environment.outputs.MOBILE_API_STAGE }}
    steps:
      - name: Set GitHub Actions Env
        id: set-environment
        run: |
          if [ ${{ github.ref }} == "refs/heads/deploy" ]; then
            echo "ENV=prod" >> $GITHUB_OUTPUT
            echo "BACK_STAGE=v5" >> $GITHUB_OUTPUT
            echo "FRONT_STAGE=v5" >> $GITHUB_OUTPUT
            echo "MOBILE_API_STAGE=v5" >> $GITHUB_OUTPUT
          else
            echo "ENV=dev" >> $GITHUB_OUTPUT
            # 開発デプロイの場合はブランチ名のハッシュをステージ変数に設定
            branch_hash=$(echo ${{ github.ref_name }} | md5sum | cut -c 1-5)
            echo "BACK_STAGE=$branch_hash" >> $GITHUB_OUTPUT
            echo "FRONT_STAGE=$branch_hash" >> $GITHUB_OUTPUT
            echo "MOBILE_API_STAGE=$branch_hash" >> $GITHUB_OUTPUT
          fi
  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '14.x'
      - name: Restore frontend cache
        uses: actions/cache@v2
        with:
          path: frontend/node_modules
          key: npm-deps-${{ github.ref_name }}-${{ hashFiles('frontend/package-lock.json') }}
      - name: Install dependencies
        run: npm ci
        working-directory: frontend
      - name: Run frontend tests
        run: npm run test
        working-directory: frontend
  backend-test:
    needs: set-environment
    environment: ${{ needs.set-environment.outputs.ENV }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/throwtrash-api-tester-role
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16.x'
      - name: Restore backend cache
        uses: actions/cache@v2
        with:
          path: backend/src/node_modules
          key: npm-deps-${{ github.ref_name }}-${{ hashFiles('backend/src/package-lock.json') }}
      - name: Install dependencies
        run: npm ci
        working-directory: backend/src
      - name: Set GCP Credentials
        run: |
          echo ${{ secrets.GCP_TEST_CREDENTIALS }} | base64 -d > backend/src/serviceAccountKey.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/backend/src/serviceAccountKey.json" >> $GITHUB_ENV
      - name: Run backend tests
        run: npm run test
        working-directory: backend/src
  mobile-backend-test:
    needs: set-environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16.x'
      - name: Restore API cache
        uses: actions/cache@v2
        with:
          path: api/src/node_modules
          key: npm-deps-${{ github.ref_name }}-${{ hashFiles('api/src/package-lock.json') }}
      - name: Install dependencies
        run: npm ci
        working-directory: api/src
      - name: Run API tests
        run: npm run test
        working-directory: api/src
  frontend-build:
    runs-on: ubuntu-latest
    needs: ["frontend-test", "set-environment"]
    environment: ${{ needs.set-environment.outputs.ENV }}
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '14.x'
      - name: Restore frontend cache
        uses: actions/cache@v2
        with:
          path: frontend/node_modules
          key: npm-deps-${{ github.ref_name }}-${{ hashFiles('frontend/package-lock.json') }}
      - name: Install dependencies
        run: npm ci
        working-directory: frontend
      - name: Build frontend
        run: npm run build -- --env stage=${{ needs.set-environment.outputs.BACK_STAGE }} --env front_stage=${{ needs.set-environment.outputs.FRONT_STAGE }}
        working-directory: frontend
      - name: Archive frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend
          path: frontend/frontend-dist/${{ needs.set-environment.outputs.FRONT_STAGE }}
          retention-days: 1
  frontend-deploy:
    needs: ["frontend-build", "set-environment"]
    environment: ${{ needs.set-environment.outputs.ENV }}
    runs-on: ubuntu-latest
    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4.1.7
        with:
          name: frontend
          path: frontend
      - name: AWS Set up
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/throwtrash-api-tester-role
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
      - name: S3 Sync
        run: |
          bucket_name="throwtrash-dev"
          if [ "${{ needs.set-environment.outputs.ENV }}" == "prod" ]; then
            bucket_name="throwtrash"
          fi
          aws s3 sync frontend/${{ env.FRONT_STAGE }} s3://${bucket_name}/${{ needs.set-environment.outputs.FRONT_STAGE }}
          # 本番デプロイ時はデプロイステージのキャッシュをクリア
          if [ "${{ github.ref_name }}" == "deploy" ]; then
            aws cloudfront create-invalidation --distribution-id ${{ vars.AWS_CLOUDFRONT_DST_ID }} --paths /${{ needs.set-environment.outputs.FRONT_STAGE }}/*
          fi
  backend-build:
    runs-on: ubuntu-latest
    needs: ["backend-test", "set-environment"]
    environment: ${{ needs.set-environment.outputs.ENV }}
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16.x'
      - name: Restore backend cache
        uses: actions/cache@v2
        with:
          key: npm-deps-${{ github.ref_name }}-${{ hashFiles('backend/src/package-lock.json') }}
          path: backend/src/node_modules
      - name: Install dependencies
        run: npm ci --production
        working-directory: backend/src
      - name: Build backend
        run: npm run build
        working-directory: backend/src
      - name: Archive backend
        uses: actions/upload-artifact@v4
        with:
          name: backend
          path: backend/src/backend-dist
          retention-days: 1
      - name: Archive backend layer
        uses: actions/upload-artifact@v4
        with:
          name: backend-layer
          path: backend/src/node_modules
          retention-days: 1
  backend-deploy:
    needs: ["backend-build", "set-environment"]
    environment: ${{ needs.set-environment.outputs.ENV }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Download backend artifact
        uses: actions/download-artifact@v4.1.7
        with:
          name: backend
          path: backend/src/backend-dist
      - name: Download backend layer
        uses: actions/download-artifact@v4.1.7
        with:
          name: backend-layer
          path: backend/src/layer/nodejs/node_modules
      - name: AWS Set up
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/throwtrash-api-deploy-role
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
      - name: Set GCP Credentials
        run: |
          echo ${{ secrets.GCP_CREDENTIALS }} | base64 -d > backend/src/backend-dist/serviceAccountKey.json
      - name: Deploy DB
        run: |
          aws cloudformation deploy --template-file backend/cfn/db-template.yml --stack-name throwtrash-backend-db --role-arn arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/throwtrash-api-deploy-cfn-role --capabilities CAPABILITY_NAMED_IAM --no-fail-on-empty-changeset --region=${{ vars.AWS_DEFAULT_REGION }}
      - name: Module Deploy
        run: |
            # lambdaでは1980年以前のタイムスタンプを持つファイルをzipできないためざっくりと1981年以前のファイル日時を更新する
            YEAR_DIFF=$(expr `date +%Y` - 1981)
            DATE_DIFF=$(expr $YEAR_DIFF \* 365)
            find backend/src/layer/nodejs/node_modules -daystart -mtime +$DATE_DIFF -exec touch {} \;

            # API/Lambdaのパッケージングとデプロイ
            aws cloudformation package --template-file backend/cfn/func-template.yml --output-template-file backend/cfn/package-template.yml --s3-bucket lambda-function-deployment-${{ needs.set-environment.outputs.ENV }} --s3-prefix throwtrashbackend

            aws cloudformation deploy --template-file backend/cfn/package-template.yml --stack-name throwtrash-backend-${{ needs.set-environment.outputs.BACK_STAGE }} --parameter-overrides Stage=${{ needs.set-environment.outputs.BACK_STAGE }} FrontendStage=${{ needs.set-environment.outputs.FRONT_STAGE }} AlexaClientID=${{ secrets.ALEXA_CLIENT_ID }} AlexaClientSecret=${{ secrets.ALEXA_CLIENT_SECRET }} GoogleClientID=${{ secrets.GOOGLE_CLIENT_ID }} GoogleClientSecret=${{ secrets.GOOGLE_CLIENT_SECRET }} RunLevel=${{ vars.RUNLEVEL }}  AlexaUserClientID=${{ secrets.ALEXA_USER_CLIENT_ID }} AlexaUserSecret=${{ secrets.ALEXA_USER_SECRET }} GoogleUserClientID=${{ secrets.GOOGLE_USER_CLIENT_ID }} GoogleUserSecret=${{ secrets.GOOGLE_USER_SECRET }} AlexaSkillID=${{ secrets.ALEXA_SKILL_ID }} ApiGatewayOrigin=${{ vars.BACKEND_API_GATEWAY_ORIGIN }} --role-arn arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/throwtrash-api-deploy-cfn-role --capabilities CAPABILITY_NAMED_IAM --no-fail-on-empty-changeset
  mobile-backend-deploy:
    needs: ["mobile-backend-test","set-environment"]
    environment: ${{ needs.set-environment.outputs.ENV }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: AWS Set up
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/throwtrash-api-deploy-role
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
      - uses: ./.github/actions/mobile-backend/build
      - name: Deploy DB
        run: |
          aws cloudformation deploy --template-file api/db-template.yml --stack-name throwtrash-mobile-db --role-arn arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/throwtrash-api-deploy-cfn-role --capabilities CAPABILITY_NAMED_IAM --no-fail-on-empty-changeset --region=${AWS_DEFAULT_REGION}
      - name: Module Deploy
        run: |
            # API/Lambdaのパッケージングとデプロイ
            aws cloudformation package --template-file api/func-template.yml --output-template-file api/package-template.yml --s3-bucket lambda-function-deployment-${{ needs.set-environment.outputs.ENV }} --s3-prefix throwtrashapi

            aws cloudformation deploy --template-file api/package-template.yml --stack-name throwtrash-mobile-${{ needs.set-environment.outputs.MOBILE_API_STAGE }} --parameter-overrides RunLevel=${{ vars.RUNLEVEL }} Stage=${{ needs.set-environment.outputs.MOBILE_API_STAGE }} SkillStage=${{ vars.SKILL_STAGE }} AlexaSkillID=${{ secrets.ALEXA_SKILL_ID }} AlexaClientID=${{ secrets.ALEXA_CLIENT_ID }} AlexaClientSecret=${{ secrets.ALEXA_CLIENT_SECRET }} AlexaUserClientID=${{ secrets.ALEXA_USER_CLIENT_ID }} AuthorizationEndpoint=${{ vars.BACKEND_API_ENDPOINT }}/${{ needs.set-environment.outputs.BACK_STAGE }} BackendApiKey=${{ secrets.BACKEND_API_KEY }} --role-arn arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/throwtrash-api-deploy-cfn-role --capabilities CAPABILITY_NAMED_IAM --no-fail-on-empty-changeset